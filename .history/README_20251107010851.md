# Graphiti Algorithm 1 (Bản Tối Giản)

Dự án tái hiện pipeline **Algorithm 1** của bài báo *Graphiti: Bridging Graph and Relational Database Queries* gồm ba bước chính:

1. **InferSDT**: chuyển lược đồ đồ thị sang lược đồ quan hệ và sinh các luật SDT.
2. **Transpile**: dịch một truy vấn Cypher (Featherweight) sang SQL IR rồi in ra SQL.
3. **ReduceToSQL**: thực thi SQL và so sánh kết quả theo tiêu chí *table equivalence*.

## Kiến trúc thư mục

```
graphiti/
  __init__.py
  cli.py
  schema/
    __init__.py
    graph_schema.py
    relational_schema.py
    sdt.py
  cypher/
    __init__.py
    ast.py
    parser_fw.py
  sqlir/
    __init__.py
    ir.py
    printer.py
  pipeline/
    __init__.py
    infer_sdt.py
    transpile.py
    reduce_sql.py
tests/
  test_graphiti.py
```

Tất cả module đều có comment/docstring tiếng Việt mô tả mục đích và mối liên hệ với bài báo.

## Giới hạn hiện tại

- Parser Featherweight Cypher chỉ hỗ trợ một `MATCH` duy nhất (hoặc `OPTIONAL MATCH`), biểu thức đơn giản (`var.prop`, hằng số, `COUNT(*)`, `COUNT(var.prop)`), và `WHERE` với các phép so sánh nối bằng `AND/OR/NOT`.
- `WITH`, `UNION`, `OPTIONAL MATCH` đa chuỗi, và nhiều mẫu nâng cao chưa được triển khai.
- Transpiler hiện chưa tận dụng trực tiếp SDT (các quy tắc đã được sinh ra để mở rộng về sau).

## Cách chạy CLI

Ví dụ:

```bash
sqlite3 examples/data.db < examples/data.sql
python -m graphiti.cli \
  --schema examples/schema.json \
  --cypher examples/query.cypher \
  --target examples/target.sql \
  --db examples/data.db
```

- `--schema`: JSON gồm danh sách `nodes` và `edges` (label + keys).
- `--cypher`: file chứa truy vấn Cypher.
- `--target` + `--db`: nếu cung cấp cả hai, CLI sẽ so sánh kết quả của SQL sinh ra với SQL đích trên cơ sở dữ liệu SQLite.

## Kiểm thử

Chạy toàn bộ kiểm thử đơn vị:

```bash
python -m unittest discover -s tests -p 'test_*.py'
```

Bộ kiểm thử bao gồm:
- Kiểm tra InferSDT tạo đúng bảng/PK/FK.
- Kiểm tra transpile sinh JOIN như mong đợi.
- Kiểm tra Table Equivalence.
- Kiểm tra end-to-end (InferSDT → Transpile → ReduceToSQL) trên SQLite in-memory.

## Hướng mở rộng

- Bổ sung hỗ trợ `WITH`, `UNION`, nhiều `MATCH` theo đúng Fig.16 của bài báo.
- Dựa vào SDT để suy ra phép chiếu tương ứng khi `RETURN` trực tiếp biến (node/edge) thay vì thuộc tính cụ thể.
- Tối ưu bộ in SQL (rút gọn ngoặc, đẩy `WHERE`).
